function initializeCalculateButton(){const t=document.getElementById("calculateBtn");t.removeAttribute("disabled"),t.addEventListener("click",handleCalculateClick)}function initializeDateInput(){const t=document.getElementById("dateInput");t&&(t.setAttribute("maxlength","10"),t.setAttribute("placeholder","дд.мм.гггг"),["input","paste"].forEach((e=>{t.addEventListener(e,handleDateInput)})),t.addEventListener("paste",handlePaste),t.addEventListener("keydown",handleKeyDown))}function handleCalculateClick(){const t=document.getElementById("dateInput");if(!t?.value)return;if(!/^\d{2}\.\d{2}\.\d{4}$/.test(t.value))return;calculateMatrix(t.value.replace(/\./g,"").split(""))}function handlePaste(t){t.preventDefault();const e=(t.clipboardData||window.clipboardData).getData("text");t.target.value=correctDate(e)}function handleDateInput(t){const{selectionStart:e,value:n}=t.target,a=n.length;t.target.value=correctDate(n),updateCursorPosition(t.target,e,a)}function updateCursorPosition(t,e,n){const a=e+(t.value.length-n);t.setSelectionRange(a,a)}function handleKeyDown(t){if("Enter"===t.key)return t.preventDefault(),void handleCalculateClick();isAllowedKey(t)||isControlCommand(t)||isValidInputCharacter(t.key)||t.preventDefault()}function isAllowedKey(t){return["Backspace","Delete","ArrowLeft","ArrowRight","Tab"].includes(t.key)}function isControlCommand(t){return t.ctrlKey||t.metaKey}function isValidInputCharacter(t){return/^\d$/.test(t)||"."===t}function correctDate(t){let e=t.replace(/[^\d]/g,"");const n=e.slice(0,2),a=e.slice(2,4),r=e.slice(4);return formatDate(correctDayValue(n),correctMonthValue(a),r)}function correctDayValue(t){return parseInt(t,10)>31?"31":t.length&&t[0]>"3"?("000"+parseInt(t,10)).slice(-2):t}function correctMonthValue(t){return parseInt(t,10)>12?"12":t.length&&t[0]>"1"?("000"+parseInt(t,10)).slice(-2):t}function formatDate(t,e,n){const a=[];return t.length&&a.push(t),e.length&&a.push(e),n.length&&a.push(n),a.join(".")}function displayGrid(t){Object.entries(t).forEach((([t,e])=>{const n=document.querySelector(`#${t} .grid-item-content`);n&&(n.textContent=e)}))}function displayResultAndShareButton(t,e){const n=document.getElementById("result"),a=document.getElementById("shareWhatsApp"),r=document.getElementById("copyBtn");if(!t||!e||!n)return;const c=`${[t.character??"—",t.energy??"—",t.interest??"—",t.health??"—",t.logics??"—",t.work??"—",t.luck??"—",t.debt??"—",t.memory??"—"].join("/")}/ЧС${e}`;n.textContent=c,a&&(a.classList.remove("hidden"),a.onclick=()=>shareToWhatsApp(c)),r&&(r.classList.remove("hidden"),r.onclick=()=>copyToClipboard(c))}function displayResults(t,e,n){displayGrid({...t,additionalNumbers:e.join(", "),destiny:n}),displayResultAndShareButton(t,n)}function calculateMatrix(t){const e=calculateAdditionalNumbers(t),n=destinyNumber(e[1]);displayResults(getMatrix(getFullNumbers([...t,...e])),e,n)}function calculateAdditionalNumbers(t){const e=[];return e[0]=firstAdditionalNumber(t),e[1]=getSumOfDigits(e[0]),e[2]=thirdAdditionalNumber(e[0],t),e[3]=getSumOfDigits(e[2]),e}function getSumOfDigits(t){return t.toString().split("").reduce(((t,e)=>t+parseInt(e,10)),0)}function firstAdditionalNumber(t){return t.reduce(((t,e)=>t+parseInt(e,10)),0)}function thirdAdditionalNumber(t,e){const n=parseInt(e[0],10),a=parseInt(e[1],10),r=0===n?a:n;return Math.abs(t-2*r)}function getFullNumbers(t){return t.reduce(((t,e)=>(e.toString().split("").forEach((e=>{t.push(parseInt(e,10))})),t)),[])}function destinyNumber(t){return 11===t?11:getSumOfDigits(t)}function getMatrix(t){const e=calculateOccurrences(t),n=calculateInnerSquare(e);return{...calculateLines(e),...calculateSquares(n)}}function calculateOccurrences(t){const e=new Array(9).fill(0);return t.forEach((t=>{t>=1&&t<=9&&e[t-1]++})),e}function calculateInnerSquare(t){return t.map(((t,e)=>t>0?`${e+1}`.repeat(t):"—"))}function calculateLines(t){return{temperament:t[2]+t[4]+t[6],target:t[0]+t[3]+t[6],family:t[1]+t[4]+t[7],habits:t[2]+t[5]+t[8],life:t[3]+t[4]+t[5]}}function calculateSquares(t){return{character:t[0],energy:t[1],interest:t[2],health:t[3],logics:t[4],work:t[5],luck:t[6],debt:t[7],memory:t[8]}}function shareToWhatsApp(t){const e=encodeURIComponent(`Здравствуйте! Мне нужна ваша консультация по психоматрице. Вот результат расчета:\n${t}`);window.open(`https://wa.me/77015323869?text=${e}`,"_blank")}async function copyToClipboard(t){try{await navigator.clipboard.writeText(t);const e=document.getElementById("copyBtn"),n=e.style.backgroundColor;e.style.backgroundColor="#575e65",setTimeout((()=>{e.style.backgroundColor=n}),1e3)}catch(t){console.error("Failed to copy text: ",t),alert("Не удалось скопировать текст")}}document.addEventListener("DOMContentLoaded",(function(){initializeCalculateButton(),initializeDateInput()}));